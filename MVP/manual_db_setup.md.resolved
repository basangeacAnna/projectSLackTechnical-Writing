# ðŸ› ï¸ Manual Database Setup Guide for ChatFlow MVP

Segui questa guida per configurare il database PostgreSQL sulla tua VM (192.168.28.128).

> **Prerequisiti**: Accesso SSH alla VM come utente con privilegi `sudo`.

## Fase 1: Installazione e Configurazione PostgreSQL

Esegui questi comandi sul terminale della VM:

```bash
# 1. Aggiorna i pacchetti e installa PostgreSQL 15
sudo apt update && sudo apt upgrade -y
sudo apt install -y postgresql postgresql-contrib postgresql-15-pg-trgm

# 2. Avvia il servizio
sudo systemctl start postgresql
sudo systemctl enable postgresql

# 3. Configura la password per l'utente 'postgres'
sudo -u postgres psql -c "ALTER USER postgres WITH PASSWORD 'postgres_secure_password_123';"

# 4. Abilita le connessioni remote
# Modifica postgresql.conf per ascoltare su tutti gli IP
echo "listen_addresses = '*'" | sudo tee -a /etc/postgresql/15/main/postgresql.conf

# Modifica pg_hba.conf per accettare connessioni con password MD5
echo "host    all             all             0.0.0.0/0               md5" | sudo tee -a /etc/postgresql/15/main/pg_hba.conf

# 5. Riavvia per applicare le modifiche
sudo systemctl restart postgresql
```

## Fase 2: Creazione Database e Utente Applicativo

```bash
# Esegui come utente postgres
sudo -u postgres psql <<EOF
-- Crea il database
CREATE DATABASE chatflow_mvp;

-- Crea l'utente per l'app
CREATE USER chatflow_app WITH PASSWORD 'chatflow_app_secure_pwd_456';

-- Concedi i privilegi
GRANT ALL PRIVILEGES ON DATABASE chatflow_mvp TO chatflow_app;
\c chatflow_mvp
GRANT ALL ON SCHEMA public TO chatflow_app;
ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO chatflow_app;
EOF
```

## Fase 3: Creazione dello Schema (Tabelle)

Crea un file chiamato `schema.sql` (puoi usare `nano schema.sql`) e incollaci il seguente contenuto SQL completo:

```sql
-- 1. USERS
CREATE TABLE IF NOT EXISTS users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    email VARCHAR(255) UNIQUE NOT NULL,
    username VARCHAR(50) UNIQUE NOT NULL,
    password_hash VARCHAR(255) NOT NULL,
    display_name VARCHAR(100),
    avatar_url VARCHAR(500),
    status VARCHAR(20) DEFAULT 'offline',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 2. WORKSPACES
CREATE TABLE IF NOT EXISTS workspaces (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name VARCHAR(100) NOT NULL,
    owner_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 3. CHANNELS
CREATE TABLE IF NOT EXISTS channels (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    workspace_id UUID NOT NULL REFERENCES workspaces(id) ON DELETE CASCADE,
    name VARCHAR(100) NOT NULL,
    creator_id UUID NOT NULL REFERENCES users(id) ON DELETE SET NULL,
    is_private BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(workspace_id, name)
);

-- 4. MESSAGES
CREATE TABLE IF NOT EXISTS messages (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    channel_id UUID NOT NULL REFERENCES channels(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE SET NULL,
    content TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
CREATE INDEX idx_messages_channel_created ON messages(channel_id, created_at DESC);
```

**Nota**: Per brevitÃ  ho incluso le tabelle core. Per lo schema completo (inclusi indici, ricerca full-text, file, notifiche, ecc.), fai riferimento al file [antigravity_db_prompt.md](file:///c:/Users/Dani/Documents/projectSLackTechnical-Writing/antigravity_db_prompt.md) presente nella tua cartella.

Esegui lo schema:
```bash
psql -h localhost -U chatflow_app -d chatflow_mvp < schema.sql
# Password richiesta: chatflow_app_secure_pwd_456
```

## Fase 4: Verifica

Prova a connetterti ed elencare le tabelle:

```bash
psql -h localhost -U chatflow_app -d chatflow_mvp -c "\dt"
```

Se vedi la lista delle tabelle (`users`, `messages`, ecc.), il database Ã¨ pronto!
